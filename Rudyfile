# = Rudy
# 
# This is an example Rudy configuration.
#
# Rudy automatically looks for configuration files in the 
# following locations (in this order):
#
#     ./.rudy/config
#     ~/.rudy/config
#
#     ./Rudyfile
#     ./config/rudy/*.rb
#     ./.rudy/*.rb
#     /etc/rudy/*.rb
#
# When multuple files are found, the configuration is 
# NOT OVERRIDDEN. It's ADDED / APPENDED. This means you can 
# split configuration across many files as you please. 
#
# There are three sections: accounts, defaults, machines, and routines.
# 
# By convention, accounts and defaults go in ~/.rudy/config or ./.rudy/config 
# machines and routines configuration goes in ./Rudyfile or 
# ./config/rudy/machines.rb and ./config/rudy/routines.rb
#

# ---------------------------------------------------------  MACHINES  --------
# The machines block describes the "physical" characteristics
# of your environments. 
machines do
  
  users do
    # If you already have private keys for logging in to your EC2 instances
    # EC2 instances you can specify them here and Rudy will use these instead.
    # root :keypair => "/#{Rudy.sysinfo.home}/.rudy/root-private-key"
  end
  
  zone :"us-east-1b" do
    ami 'ami-235fba4a'    # Amazon Getting Started AMI (US)
  end
  zone :"eu-west-1b" do
    ami 'ami-e40f2790'    # Amazon Getting Started AMI (EU)
  end

  # We've defined an environment called "stage" with one role: "app". 
  # The configuration inside the env block is available to all its 
  # roles. The configuration inside the role blocks is available only
  # to machines in that specific role. 
  env :stage do
    ami "ami-5394733a"    # ec2onrails/ec2onrails-v0_9_9_1-i386.manifest.xml
    size 'm1.small'
    
    role :app do
      positions 1
      #addresses '11.22.33.44', '55.66.77.88'
      
      # You can define disks for the stage-app machines. Rudy uses 
      # this configuration when it executes a routine (see below).
      disks do
        path "/rudy/disk1" do
          size 2
          device "/dev/sdr"
        end
      end
      
    end
    
    # Here are some examples of other roles. You can use these or
    # remove them and create your own.
    role :db do
    end
    
    role :analysis do
    end
    
    role :balancer do
    end
    
  end  

  # The routines section below contains calls to local and remote
  # scripts. The config contained in this block is made available
  # those scripts in the form of a yaml file. The file is called
  # rudy-config.yml. 
  config do                 
    dbmaster 'localhost'
    newparam 573114
  end
  
  
end

# ----------------------------------------------------------- ROUTINES --------
# The routines block describes the repeatable processes for each machine group.
# To run a routine, specify its name on the command-line: rudy startup
routines do
  
  env :stage do                       # We'll define routines for the
    role :app do                      # stage-app machine group

      startup do                      # $ rudy startup
        
        adduser :rudy                 # Create a user called "rudy"
        authorize :rudy               # Enable passwordless logins as rudy
        
        disks do                      # Define EBS volume routines
          create "/rudy/disk1"        # Create an EBS volume, attach it, give
        end                           # it a filesystem, and mount it.
        
        after :rudy do                # Run remote SSH commands after startup.
          mkdir :p, "great"           # $ mkdir -p great
          touch "great/scott"         # $ touch great/scott
          ls :l, :a                   # $ ls -l -a
        end
      end
      
      shutdown do                     # $ rudy shutdown
        
        before :root do
        end
        
        disks do
          destroy "/rudy/disk1"       # Unmount and destroy the EBS volume
        end
      end
      
    end
  end
end


# ----------------------------------------------------------- COMMANDS --------
# The commands block defines shell commands to be allowed or denied from the 
# default list defined by Rye::Cmd (Rudy executes all SSH commands via Rye).
# The shells commands are 
commands do
  allow :mongrel_rails
  deny :ps
end
