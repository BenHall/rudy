# = Rudy
# 
# This is an example Rudy configuration.
#
# Rudy automatically looks for configuration files in the 
# following locations (in this order):
#
#     ~/.rudy/config
#     ./.rudy/config
#
#     ./Rudyfile
#     ./config/rudy/*.rb
#     ./.rudy/*.rb
#     /etc/rudy/*.rb
#
# When multuple files are found, the configuration is 
# NOT OVERRIDDEN. It's ADDED / APPENDED. This means you can 
# split configuration across many files as you please. 
#
# There are three sections: accounts, defaults, machines. 
# 
# By convention, accounts and defaults go in ~/.rudy/config or ./.rudy/config 
# machines configuration goes in ./Rudyfile or ./config/rudy/machines.rb


# ---------------------------------------------------------  MACHINES  --------
# The machines block describes the "physical" characteristics
# of your environments. 
machines do
  
  users do
    # If you already have private keys for logging in to your EC2 instances
    # EC2 instances you can specify them here and Rudy will use these instead.
    #root :keypair => "path/2/root-private-key"
  end
  
  zone :"us-east-1b" do
    ami 'ami-235fba4a'    # Amazon Getting Started AMI (US)
  end
  zone :"eu-west-1b" do
    ami 'ami-e40f2790'    # Amazon Getting Started AMI (EU)
  end

  # We've defined an environment called "stage" with one role: "app". 
  # The configuration inside the env block is available to all its 
  # roles. The configuration inside the role blocks is available only
  # to machines in that specific role. 
  env :stage do
    ami "ami-5394733a"    # ec2onrails/ec2onrails-v0_9_9_1-i386.manifest.xml
    size 'm1.small'
    
    role :app do
      positions 1
      
      # We've given the stage-app machines two disks.
      disks do
        path "/rudy/example1" do
          size 2
          device "/dev/sdr"
        end
        path "/rudy/example2" do
          size 1 
          device "/dev/sdm"
        end
      end
      
    end

  end  

  # The routines section below contains calls to local and remote
  # scripts. The config contained in this block is made available
  # those scripts in the form of a yaml file. The file is called
  # rudy-config.yml. 
  config do
    dbmaster 'localhost'
    newparam 573114
  end
  
  
end

# ----------------------------------------------------------- ROUTINES --------
# The routines block describes the repeatable processes for each machine group.
routines do
  
  env :stage do
    role :app do
      
      startup do
        before_local Rudy.sysinfo.user => [:uname, :a]
        
        disks do
          create "/rudy/example1"
        end
        
        after :root => '/bad/script'
        after :root => [:ls, :l, '/']
        after_local Rudy.sysinfo.user => :date
      end
      
      restart do
        before :root => [:which, 'date']
        after :rudy => "/usr/bin/date"
        
        disks do
          mount "/rudy/example1"
        end
      end
      
      shutdown do
        before :root => [:echo, 'BEFORE SHUTDOWN']
        disks do
          destroy "/rudy/example1"
        end
      end
      
    end
  end
end

